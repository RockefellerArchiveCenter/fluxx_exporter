
{% extends 'exporttool/main.html' %}

{% block content %}

    <table>
        <tr>
            <th>Entity</th>
        </tr>
        {% for entity in entities %}
        <tr>
            <td><strong>{{ entity.name }}</strong></td>
            {% for column in entity.column_set.all %}
            <td>{{ column }}  <input type="checkbox" name="{{ entity.name }}|{{ column.name }}"></td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>
    
    <div>
        <label for="filterInput">Filter:</label>
        <input type="text" id="filterInput" name="filterInput">
    </div>

    <div>
        <label for="formatInput">Format:</label>
        <select id="formatInput" name="formatInput">
            <option value="1">JSON</option>
            <option value="2">XML</option>
            <option value="3">CSV</option>
        </select>
    </div>
    
    <div>
        <label for="folderInput">Select Output Folder:</label>
        <button onclick="selectFolder()">Browse</button>
    </div>
    
    <button onclick="exportData()">Export</button>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    <script>
    let selectedFolderHandle = null;

    async function selectFolder() {
        selectedFolderHandle = await window.showDirectoryPicker();
        console.log("Selected Folder Handle:", selectedFolderHandle);
    }

    async function exportData() {
        var checkedColumns = [];
        {% for entity in entities %}
            {% for column in entity.column_set.all %}
                var checkbox = document.querySelector('input[name="{{ entity.name }}|{{ column.name }}"]');
                if (checkbox && checkbox.checked) {
                    checkedColumns.push('{{ entity.name }}|{{ column.name }}');
                }
            {% endfor %}
        {% endfor %}
        console.log(checkedColumns);

        // Retrieve filter value
        var filterValue = document.getElementById('filterInput').value;
        console.log('Filter:', filterValue);

        // Retrieve format value
        var formatValue = document.getElementById('formatInput').value;
        console.log('Format:', formatValue);

        // Get folder name from the handle (not the full path)
        let folderPath = selectedFolderHandle ? selectedFolderHandle.name : '';
        console.log('Folder Path:', folderPath);
        // Send data to export_data view using AJAX
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'export_data' %}", true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');  // Include CSRF token

        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log('Data exported successfully.');
            } else {
                console.error('Failed to export data.');
            }
        };

        // Send checked columns, filter value, format value, and folder path
        var postData = {
            checkedColumns: checkedColumns,
            filter: filterValue,
            format: formatValue,
            folderPath: folderPath
        };
        xhr.send(JSON.stringify(postData));
        console.log(JSON.stringify(postData));
    }
    </script>

{% endblock %}
